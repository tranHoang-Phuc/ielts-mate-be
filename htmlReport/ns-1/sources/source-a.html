


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > VocabularyServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.fptu.sep490.personalservice.service.impl</a>
</div>

<h1>Coverage Summary for Class: VocabularyServiceImpl (com.fptu.sep490.personalservice.service.impl)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">VocabularyServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/139)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.fptu.sep490.personalservice.service.impl;
&nbsp;
&nbsp;
&nbsp;import com.fptu.sep490.commonlibrary.exceptions.AppException;
&nbsp;import com.fptu.sep490.personalservice.constants.Constants;
&nbsp;import com.fptu.sep490.personalservice.helper.Helper;
&nbsp;import com.fptu.sep490.personalservice.model.Vocabulary;
&nbsp;import com.fptu.sep490.personalservice.repository.ConfigRepository;
&nbsp;import com.fptu.sep490.personalservice.repository.VocabularyRepository;
&nbsp;import com.fptu.sep490.personalservice.service.VocabularyService;
&nbsp;import com.fptu.sep490.personalservice.viewmodel.request.VocabularyRequest;
&nbsp;import com.fptu.sep490.personalservice.viewmodel.response.VocabularyResponse;
&nbsp;import jakarta.servlet.http.HttpServletRequest;
&nbsp;import lombok.AccessLevel;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.experimental.FieldDefaults;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.data.domain.*;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;
&nbsp;import java.util.List;
&nbsp;import java.util.UUID;
&nbsp;
&nbsp;@Service
&nbsp;@FieldDefaults(level = AccessLevel.PACKAGE, makeFinal = true)
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RequiredArgsConstructor(access = AccessLevel.PACKAGE)
&nbsp;public class VocabularyServiceImpl  implements VocabularyService {
&nbsp;    ConfigRepository configRepository;
&nbsp;    VocabularyRepository vocabularyRepository;
&nbsp;    Helper helper;
&nbsp;    AIServiceImpl aiServiceImpl;
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public VocabularyResponse createVocabulary(VocabularyRequest vocabularyRequest, HttpServletRequest httpServletRequest) throws Exception {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(httpServletRequest);</b>
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (vocabularyRequest.word() == null || vocabularyRequest.word().isBlank()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.INVALID_REQUEST,</b>
<b class="nc">&nbsp;                    Constants.ErrorCode.INVALID_REQUEST,</b>
<b class="nc">&nbsp;                    HttpStatus.BAD_REQUEST.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;//        Vocabulary existingVocabulary = vocabularyRepository.findByWordAndCreatedBy(vocabularyRequest.word(), userId);
&nbsp;//        if (existingVocabulary != null) {
&nbsp;//            throw new AppException(
&nbsp;//                    Constants.ErrorCodeMessage.VOCABULARY_ALREADY_EXISTS,
&nbsp;//                    Constants.ErrorCode.VOCABULARY_ALREADY_EXISTS,
&nbsp;//                    HttpStatus.CONFLICT.value()
&nbsp;//            );
&nbsp;//        }
<b class="nc">&nbsp;        Vocabulary newVocabulary = new Vocabulary();</b>
<b class="nc">&nbsp;        newVocabulary.setWord(vocabularyRequest.word());</b>
<b class="nc">&nbsp;        newVocabulary.setContext(vocabularyRequest.context());</b>
<b class="nc">&nbsp;        newVocabulary.setIsPublic(vocabularyRequest.isPublic());</b>
<b class="nc">&nbsp;        newVocabulary.setCreatedBy(userId);</b>
&nbsp;
&nbsp;
&nbsp;        // Auto-fill meaning using AI API if not provided
<b class="nc">&nbsp;        String meaning = vocabularyRequest.meaning();</b>
<b class="nc">&nbsp;        if (meaning == null || meaning.isBlank()) {</b>
&nbsp;            // Replace with your actual AI API call
&nbsp;
<b class="nc">&nbsp;            meaning = aiServiceImpl.getVocabularyDefinition(vocabularyRequest.word(), vocabularyRequest.context(), vocabularyRequest.language());</b>
&nbsp;        }
<b class="nc">&nbsp;        newVocabulary.setMeaning(meaning);</b>
&nbsp;
<b class="nc">&nbsp;        vocabularyRepository.save(newVocabulary);</b>
&nbsp;
<b class="nc">&nbsp;        return VocabularyResponse.builder()</b>
<b class="nc">&nbsp;                .vocabularyId(newVocabulary.getWordId())</b>
<b class="nc">&nbsp;                .word(newVocabulary.getWord())</b>
<b class="nc">&nbsp;                .context(newVocabulary.getContext())</b>
<b class="nc">&nbsp;                .meaning(newVocabulary.getMeaning())</b>
<b class="nc">&nbsp;                .createdBy(newVocabulary.getCreatedBy())</b>
<b class="nc">&nbsp;                .createdAt(newVocabulary.getCreatedAt())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public VocabularyResponse getVocabularyById(String vocabularyId, HttpServletRequest request) throws Exception {
<b class="nc">&nbsp;        String UserId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (UserId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        Vocabulary vocabulary = vocabularyRepository.findById(UUID.fromString(vocabularyId))</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        HttpStatus.NOT_FOUND.value()</b>
&nbsp;                ));
<b class="nc">&nbsp;        if (vocabulary.getIsDeleted()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    HttpStatus.GONE.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return VocabularyResponse.builder()</b>
<b class="nc">&nbsp;                .vocabularyId(vocabulary.getWordId())</b>
<b class="nc">&nbsp;                .word(vocabulary.getWord())</b>
<b class="nc">&nbsp;                .context(vocabulary.getContext())</b>
<b class="nc">&nbsp;                .meaning(vocabulary.getMeaning())</b>
<b class="nc">&nbsp;                .createdBy(vocabulary.getCreatedBy())</b>
<b class="nc">&nbsp;                .createdAt(vocabulary.getCreatedAt())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteVocabularyById(String vocabularyId, HttpServletRequest request) throws Exception {
<b class="nc">&nbsp;        String UserId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (UserId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Vocabulary vocabulary = vocabularyRepository.findById(UUID.fromString(vocabularyId))</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        HttpStatus.NOT_FOUND.value()</b>
&nbsp;                ));
<b class="nc">&nbsp;        vocabulary.setIsDeleted(true);</b>
<b class="nc">&nbsp;        vocabularyRepository.save(vocabulary); // Đừng quên lưu lại thay đổi!</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Page&lt;VocabularyResponse&gt; getAllVocabulary(HttpServletRequest request, int page, int size, String sortBy, String sortDirection, String keyword) throws Exception {
<b class="nc">&nbsp;        String UserId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (UserId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        if (sortBy == null || sortBy.isBlank()) {</b>
<b class="nc">&nbsp;            sortBy = &quot;createdAt&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (sortDirection == null || sortDirection.isBlank()) {</b>
<b class="nc">&nbsp;            sortDirection = &quot;asc&quot;;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Sort sort = sortDirection.equalsIgnoreCase(&quot;desc&quot;)</b>
<b class="nc">&nbsp;                ? Sort.by(sortBy).descending()</b>
<b class="nc">&nbsp;                : Sort.by(sortBy).ascending();</b>
<b class="nc">&nbsp;        Pageable pageable = PageRequest.of(page, size, sort);</b>
&nbsp;
&nbsp;        Page&lt;Vocabulary&gt; vocabularyPage;
&nbsp;        try {
&nbsp;
<b class="nc">&nbsp;            vocabularyPage = vocabularyRepository.searchVocabulary(keyword, pageable, UserId);</b>
&nbsp;
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;Database error when fetching exams for user: {}&quot;, UserId, e);</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.INTERNAL_SERVER_ERROR,</b>
<b class="nc">&nbsp;                    Constants.ErrorCode.INTERNAL_SERVER_ERROR,</b>
<b class="nc">&nbsp;                    HttpStatus.INTERNAL_SERVER_ERROR.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        List&lt;VocabularyResponse&gt; vocabularyResponses = vocabularyPage.stream()</b>
<b class="nc">&nbsp;                .map(vocabulary -&gt; VocabularyResponse.builder()</b>
<b class="nc">&nbsp;                        .vocabularyId(vocabulary.getWordId())</b>
<b class="nc">&nbsp;                        .word(vocabulary.getWord())</b>
<b class="nc">&nbsp;                        .context(vocabulary.getContext())</b>
<b class="nc">&nbsp;                        .meaning(vocabulary.getMeaning())</b>
<b class="nc">&nbsp;                        .createdBy(vocabulary.getCreatedBy())</b>
<b class="nc">&nbsp;                        .createdAt(vocabulary.getCreatedAt())</b>
<b class="nc">&nbsp;                        .build())</b>
<b class="nc">&nbsp;                .toList();</b>
&nbsp;
&nbsp;
<b class="nc">&nbsp;        return new PageImpl&lt;&gt;(vocabularyResponses, pageable, vocabularyPage.getTotalElements());</b>
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public VocabularyResponse updateVocabulary(String vocabularyId, VocabularyRequest vocabularyRequest, HttpServletRequest request) throws Exception {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        Vocabulary vocabulary = vocabularyRepository.findById(UUID.fromString(vocabularyId))</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        HttpStatus.NOT_FOUND.value()</b>
&nbsp;                ));
<b class="nc">&nbsp;        if (!vocabulary.getCreatedBy().equals(userId)) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    HttpStatus.FORBIDDEN.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        if (vocabularyRequest.word() == null || vocabularyRequest.word().isBlank()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.INVALID_REQUEST,</b>
<b class="nc">&nbsp;                    Constants.ErrorCode.INVALID_REQUEST,</b>
<b class="nc">&nbsp;                    HttpStatus.BAD_REQUEST.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        Vocabulary existingVocabulary = vocabularyRepository.findByWordAndCreatedBy(vocabularyRequest.word(), userId);</b>
<b class="nc">&nbsp;        if (existingVocabulary != null &amp;&amp; !existingVocabulary.getWordId().equals(vocabulary.getWordId())) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.VOCABULARY_ALREADY_EXISTS,</b>
<b class="nc">&nbsp;                    Constants.ErrorCode.VOCABULARY_ALREADY_EXISTS,</b>
<b class="nc">&nbsp;                    HttpStatus.CONFLICT.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        vocabulary.setWord(vocabularyRequest.word());</b>
<b class="nc">&nbsp;        vocabulary.setContext(vocabularyRequest.context());</b>
<b class="nc">&nbsp;        vocabulary.setMeaning(vocabularyRequest.meaning());</b>
<b class="nc">&nbsp;        vocabulary.setIsPublic(vocabularyRequest.isPublic());</b>
<b class="nc">&nbsp;        vocabulary.setUpdatedBy(userId);</b>
<b class="nc">&nbsp;        vocabularyRepository.save(vocabulary);</b>
<b class="nc">&nbsp;        return VocabularyResponse.builder()</b>
<b class="nc">&nbsp;                .vocabularyId(vocabulary.getWordId())</b>
<b class="nc">&nbsp;                .word(vocabulary.getWord())</b>
<b class="nc">&nbsp;                .context(vocabulary.getContext())</b>
<b class="nc">&nbsp;                .meaning(vocabulary.getMeaning())</b>
<b class="nc">&nbsp;                .createdBy(vocabulary.getCreatedBy())</b>
<b class="nc">&nbsp;                .createdAt(vocabulary.getCreatedAt())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-08-14 07:34</div>
</div>
</body>
</html>
