


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ModuleServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.fptu.sep490.personalservice.service.impl</a>
</div>

<h1>Coverage Summary for Class: ModuleServiceImpl (com.fptu.sep490.personalservice.service.impl)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ModuleServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/42)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/248)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/872)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.fptu.sep490.personalservice.service.impl;
&nbsp;
&nbsp;import com.fptu.sep490.commonlibrary.exceptions.AppException;
&nbsp;import com.fptu.sep490.commonlibrary.viewmodel.response.BaseResponse;
&nbsp;import com.fptu.sep490.personalservice.constants.Constants;
&nbsp;import com.fptu.sep490.personalservice.helper.Helper;
&nbsp;import com.fptu.sep490.personalservice.model.*;
&nbsp;import com.fptu.sep490.personalservice.model.Module;
&nbsp;import com.fptu.sep490.personalservice.model.enumeration.LearningStatus;
&nbsp;import com.fptu.sep490.personalservice.model.enumeration.ModuleUserStatus;
&nbsp;import com.fptu.sep490.personalservice.repository.*;
&nbsp;import com.fptu.sep490.personalservice.repository.client.AuthClient;
&nbsp;import com.fptu.sep490.personalservice.service.ModuleService;
&nbsp;import com.fptu.sep490.personalservice.viewmodel.request.*;
&nbsp;import com.fptu.sep490.personalservice.viewmodel.response.*;
&nbsp;import jakarta.servlet.http.HttpServletRequest;
&nbsp;import lombok.AccessLevel;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.experimental.FieldDefaults;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.data.domain.*;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.http.ResponseEntity;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;import java.util.UUID;
&nbsp;
&nbsp;@Service
&nbsp;@FieldDefaults(level = AccessLevel.PACKAGE, makeFinal = true)
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@RequiredArgsConstructor(access = AccessLevel.PACKAGE)
&nbsp;public class ModuleServiceImpl implements ModuleService {
&nbsp;    FlashCardRepository flashCardRepository;
&nbsp;    ModuleRepository moduleRepository;
&nbsp;    VocabularyRepository vocabularyRepository;
&nbsp;    FlashCardModuleRepository flashCardModuleRepository;
&nbsp;    ModuleUsersRepository moduleUsersRepository;
&nbsp;    FlashCardProgressRepository flashCardProgressRepository;
&nbsp;    Helper helper;
&nbsp;    AuthClient authClient;
&nbsp;
&nbsp;    @Override
&nbsp;    public ModuleResponse createModule(ModuleRequest moduleRequest, HttpServletRequest request) throws Exception {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new Exception(&quot;Unauthorized: User ID is null&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;
<b class="nc">&nbsp;        List&lt;UUID&gt; vocabularyIds = moduleRequest.vocabularyIds();</b>
&nbsp;
<b class="nc">&nbsp;        Module newModule = new Module();</b>
<b class="nc">&nbsp;        newModule.setModuleName(moduleRequest.moduleName());</b>
<b class="nc">&nbsp;        newModule.setDescription(moduleRequest.moduleDescription());</b>
<b class="nc">&nbsp;        newModule.setIsPublic(moduleRequest.isPublic());</b>
<b class="nc">&nbsp;        newModule.setCreatedBy(userId);</b>
&nbsp;
&nbsp;        // Save module first to get its ID
<b class="nc">&nbsp;        Module savedModule = moduleRepository.save(newModule);</b>
&nbsp;
&nbsp;        // Save connection at ModuleUsers then the creator can access the module
<b class="nc">&nbsp;        ModuleUsers moduleUsers = new ModuleUsers();</b>
<b class="nc">&nbsp;        moduleUsers.setModule(savedModule);</b>
<b class="nc">&nbsp;        moduleUsers.setUserId(userId);</b>
<b class="nc">&nbsp;        moduleUsers.setStatus(ModuleUserStatus.ACCEPTED.ordinal());</b>
<b class="nc">&nbsp;        moduleUsers.setCreatedBy(userId);</b>
<b class="nc">&nbsp;        moduleUsers.setStatus(1);</b>
<b class="nc">&nbsp;        moduleUsersRepository.save(moduleUsers);</b>
&nbsp;
<b class="nc">&nbsp;        for (UUID vocabularyId : vocabularyIds) {</b>
<b class="nc">&nbsp;            Vocabulary vocabulary = vocabularyRepository.findById(vocabularyId)</b>
<b class="nc">&nbsp;                    .orElseThrow(() -&gt; new Exception(&quot;Vocabulary not found: &quot; + vocabularyId));</b>
&nbsp;
<b class="nc">&nbsp;            Optional&lt;FlashCard&gt; existingFlashCard = flashCardRepository.findByVocabularyId(vocabularyId, userId);</b>
&nbsp;
<b class="nc">&nbsp;            FlashCard flashCard = existingFlashCard.orElseGet(() -&gt; {</b>
<b class="nc">&nbsp;                FlashCard newCard = new FlashCard();</b>
<b class="nc">&nbsp;                newCard.setVocabulary(vocabulary);</b>
<b class="nc">&nbsp;                newCard.setCreatedBy(userId);</b>
<b class="nc">&nbsp;                return flashCardRepository.save(newCard);</b>
&nbsp;            });
&nbsp;
&nbsp;
<b class="nc">&nbsp;            FlashCardModule flashCardModule = new FlashCardModule();</b>
<b class="nc">&nbsp;            flashCardModule.setFlashCard(flashCard);</b>
<b class="nc">&nbsp;            flashCardModule.setModule(savedModule);</b>
&nbsp;
<b class="nc">&nbsp;            flashCard.getFlashCardModules().add(flashCardModule);</b>
<b class="nc">&nbsp;            savedModule.getFlashCardModules().add(flashCardModule);</b>
&nbsp;
<b class="nc">&nbsp;            flashCardModuleRepository.save(flashCardModule);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Build response
<b class="nc">&nbsp;        List&lt;FlashCardResponse&gt; flashCardResponses = savedModule.getFlashCards().stream()</b>
<b class="nc">&nbsp;                .map(flashCard -&gt; FlashCardResponse.builder()</b>
<b class="nc">&nbsp;                        .flashCardId(flashCard.getCardId().toString())</b>
<b class="nc">&nbsp;                        .vocabularyResponse(</b>
<b class="nc">&nbsp;                                VocabularyResponse.builder()</b>
<b class="nc">&nbsp;                                        .vocabularyId(flashCard.getVocabulary().getWordId())</b>
<b class="nc">&nbsp;                                        .word(flashCard.getVocabulary().getWord())</b>
<b class="nc">&nbsp;                                        .context(flashCard.getVocabulary().getContext())</b>
<b class="nc">&nbsp;                                        .meaning(flashCard.getVocabulary().getMeaning())</b>
<b class="nc">&nbsp;                                        .createdBy(flashCard.getVocabulary().getCreatedBy())</b>
<b class="nc">&nbsp;                                        .createdAt(flashCard.getVocabulary().getCreatedAt())</b>
<b class="nc">&nbsp;                                        .build()</b>
&nbsp;                        )
<b class="nc">&nbsp;                        .build())</b>
<b class="nc">&nbsp;                .toList();</b>
&nbsp;
<b class="nc">&nbsp;        return ModuleResponse.builder()</b>
<b class="nc">&nbsp;                .moduleId(savedModule.getModuleId())</b>
<b class="nc">&nbsp;                .moduleName(savedModule.getModuleName())</b>
<b class="nc">&nbsp;                .description(savedModule.getDescription())</b>
<b class="nc">&nbsp;                .isPublic(savedModule.getIsPublic())</b>
<b class="nc">&nbsp;                .flashCardIds(flashCardResponses)</b>
<b class="nc">&nbsp;                .createdBy(savedModule.getCreatedBy())</b>
<b class="nc">&nbsp;                .createdAt(savedModule.getCreatedAt())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Page&lt;ModuleResponse&gt; getAllModules(HttpServletRequest request, int page, int size, String sortBy, String sortDirection, String keyword) throws Exception {
<b class="nc">&nbsp;        String UserId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (UserId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );        }
<b class="nc">&nbsp;        if (sortBy == null || sortBy.isBlank()) {</b>
<b class="nc">&nbsp;            sortBy = &quot;createdAt&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (sortDirection == null || sortDirection.isBlank()) {</b>
<b class="nc">&nbsp;            sortDirection = &quot;asc&quot;;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Sort sort = sortDirection.equalsIgnoreCase(&quot;desc&quot;)</b>
<b class="nc">&nbsp;                ? Sort.by(sortBy).descending()</b>
<b class="nc">&nbsp;                : Sort.by(sortBy).ascending();</b>
<b class="nc">&nbsp;        Pageable pageable = PageRequest.of(page, size, sort);</b>
&nbsp;        Page&lt;Module&gt; modulePage;
&nbsp;        try {
<b class="nc">&nbsp;            modulePage = moduleRepository.searchModuleByUser(keyword, pageable, UserId);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;Database error when fetching modules for user: {}&quot;, UserId, e);</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.INTERNAL_SERVER_ERROR,</b>
<b class="nc">&nbsp;                    Constants.ErrorCode.INTERNAL_SERVER_ERROR,</b>
<b class="nc">&nbsp;                    HttpStatus.INTERNAL_SERVER_ERROR.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        List&lt;ModuleResponse&gt; moduleResponses = modulePage.stream()</b>
<b class="nc">&nbsp;                .map(module -&gt; {</b>
<b class="nc">&nbsp;                    List&lt;FlashCardResponse&gt; flashCardResponses = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                    for (FlashCard flashCard : module.getFlashCards()) {</b>
<b class="nc">&nbsp;                        flashCardResponses.add(FlashCardResponse.builder()</b>
<b class="nc">&nbsp;                                .flashCardId(flashCard.getCardId().toString())</b>
<b class="nc">&nbsp;                                .vocabularyResponse(</b>
<b class="nc">&nbsp;                                        VocabularyResponse.builder()</b>
<b class="nc">&nbsp;                                                .vocabularyId(flashCard.getVocabulary().getWordId())</b>
<b class="nc">&nbsp;                                                .word(flashCard.getVocabulary().getWord())</b>
<b class="nc">&nbsp;                                                .context(flashCard.getVocabulary().getContext())</b>
<b class="nc">&nbsp;                                                .meaning(flashCard.getVocabulary().getMeaning())</b>
<b class="nc">&nbsp;                                                .createdBy(flashCard.getVocabulary().getCreatedBy())</b>
<b class="nc">&nbsp;                                                .createdAt(flashCard.getVocabulary().getCreatedAt())</b>
<b class="nc">&nbsp;                                                .build()</b>
&nbsp;                                )
<b class="nc">&nbsp;                                .build());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    ModuleUsers moduleUser = module.getModuleUsers().stream()</b>
<b class="nc">&nbsp;                            .filter(mu -&gt; mu.getUserId().equals(UserId))</b>
<b class="nc">&nbsp;                            .findFirst()</b>
<b class="nc">&nbsp;                            .orElse(null);</b>
&nbsp;
<b class="nc">&nbsp;                    Long timeSpent = moduleUser != null ? moduleUser.getTimeSpent() : null;</b>
<b class="nc">&nbsp;                    Double progress = moduleUser != null ? moduleUser.getProgress() : null;</b>
<b class="nc">&nbsp;                    LearningStatus learningStatus = moduleUser != null ? moduleUser.getLearningStatus() :null;</b>
<b class="nc">&nbsp;                    return ModuleResponse.builder()</b>
<b class="nc">&nbsp;                            .moduleId(module.getModuleId())</b>
<b class="nc">&nbsp;                            .moduleName(module.getModuleName())</b>
<b class="nc">&nbsp;                            .description(module.getDescription())</b>
<b class="nc">&nbsp;                            .isPublic(module.getIsPublic())</b>
<b class="nc">&nbsp;                            .flashCardIds(flashCardResponses)</b>
<b class="nc">&nbsp;                            .createdBy(module.getCreatedBy())</b>
<b class="nc">&nbsp;                            .createdAt(module.getCreatedAt())</b>
<b class="nc">&nbsp;                            .updatedBy(module.getUpdatedBy())</b>
<b class="nc">&nbsp;                            .updatedAt(module.getUpdatedAt())</b>
<b class="nc">&nbsp;                            .timeSpent(timeSpent)</b>
<b class="nc">&nbsp;                            .progress(progress)</b>
<b class="nc">&nbsp;                            .learningStatus(learningStatus)</b>
<b class="nc">&nbsp;                            .build();</b>
&nbsp;                })
<b class="nc">&nbsp;                .toList();</b>
&nbsp;
<b class="nc">&nbsp;        return new PageImpl&lt;&gt;(moduleResponses, pageable,modulePage.getTotalElements());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Page&lt;ModuleResponse&gt; getAllPublicModules(int page, int size, String sortBy, String sortDirection, String keyword, HttpServletRequest httpServletRequest) throws Exception {
<b class="nc">&nbsp;        String UserId = helper.getUserIdFromToken(httpServletRequest);</b>
<b class="nc">&nbsp;        if (UserId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        if (sortBy == null || sortBy.isBlank()) {</b>
<b class="nc">&nbsp;            sortBy = &quot;createdAt&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (sortDirection == null || sortDirection.isBlank()) {</b>
<b class="nc">&nbsp;            sortDirection = &quot;asc&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        Sort sort = sortDirection.equalsIgnoreCase(&quot;desc&quot;)</b>
<b class="nc">&nbsp;                ? Sort.by(sortBy).descending()</b>
<b class="nc">&nbsp;                : Sort.by(sortBy).ascending();</b>
<b class="nc">&nbsp;        Pageable pageable = PageRequest.of(page, size, sort);</b>
&nbsp;        Page&lt;Module&gt; modulePage;
&nbsp;        try {
<b class="nc">&nbsp;            modulePage = moduleRepository.searchMyAndPublicModules(keyword, pageable, UserId);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;Database error when fetching public modules for user: {}&quot;, UserId, e);</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.INTERNAL_SERVER_ERROR,</b>
<b class="nc">&nbsp;                    Constants.ErrorCode.INTERNAL_SERVER_ERROR,</b>
<b class="nc">&nbsp;                    HttpStatus.INTERNAL_SERVER_ERROR.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        List&lt;ModuleResponse&gt; moduleResponses = modulePage.stream()</b>
<b class="nc">&nbsp;                .map(module -&gt; {</b>
<b class="nc">&nbsp;                    List&lt;FlashCardResponse&gt; flashCardResponses = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                    for (FlashCard flashCard : module.getFlashCards()) {</b>
<b class="nc">&nbsp;                        flashCardResponses.add(FlashCardResponse.builder()</b>
<b class="nc">&nbsp;                                .flashCardId(flashCard.getCardId().toString())</b>
<b class="nc">&nbsp;                                .vocabularyResponse(</b>
<b class="nc">&nbsp;                                        VocabularyResponse.builder()</b>
<b class="nc">&nbsp;                                                .vocabularyId(flashCard.getVocabulary().getWordId())</b>
<b class="nc">&nbsp;                                                .word(flashCard.getVocabulary().getWord())</b>
<b class="nc">&nbsp;                                                .context(flashCard.getVocabulary().getContext())</b>
<b class="nc">&nbsp;                                                .meaning(flashCard.getVocabulary().getMeaning())</b>
<b class="nc">&nbsp;                                                .createdBy(flashCard.getVocabulary().getCreatedBy())</b>
<b class="nc">&nbsp;                                                .createdAt(flashCard.getVocabulary().getCreatedAt())</b>
<b class="nc">&nbsp;                                                .build()</b>
&nbsp;                                )
<b class="nc">&nbsp;                                .build());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return ModuleResponse.builder()</b>
<b class="nc">&nbsp;                            .moduleId(module.getModuleId())</b>
<b class="nc">&nbsp;                            .moduleName(module.getModuleName())</b>
<b class="nc">&nbsp;                            .description(module.getDescription())</b>
<b class="nc">&nbsp;                            .isPublic(module.getIsPublic())</b>
<b class="nc">&nbsp;                            .flashCardIds(flashCardResponses)</b>
<b class="nc">&nbsp;                            .createdBy(module.getCreatedBy())</b>
<b class="nc">&nbsp;                            .createdAt(module.getCreatedAt())</b>
<b class="nc">&nbsp;                            .updatedBy(module.getUpdatedBy())</b>
<b class="nc">&nbsp;                            .updatedAt(module.getUpdatedAt())</b>
<b class="nc">&nbsp;                            .build();</b>
&nbsp;                })
<b class="nc">&nbsp;                .toList();</b>
&nbsp;
<b class="nc">&nbsp;        return new PageImpl&lt;&gt;(moduleResponses, pageable,modulePage.getTotalElements());</b>
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void deleteModuleById(String moduleId, HttpServletRequest request) throws Exception {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Module module = moduleRepository.findById(UUID.fromString(moduleId))</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        HttpStatus.NOT_FOUND.value()</b>
&nbsp;                ));
<b class="nc">&nbsp;        if (!module.getCreatedBy().equals(userId)) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    HttpStatus.FORBIDDEN.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        module.setIsDeleted(true);</b>
<b class="nc">&nbsp;        moduleRepository.save(module);</b>
&nbsp;
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ModuleResponse getModuleById(String moduleId, HttpServletRequest request) throws Exception {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        Module module = moduleRepository.findById(UUID.fromString(moduleId))</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        HttpStatus.NOT_FOUND.value()</b>
&nbsp;                ));
<b class="nc">&nbsp;        if (module.getIsDeleted()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    HttpStatus.NOT_FOUND.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        ModuleUsers moduleUser = moduleUsersRepository.findByModuleIdAndUserId(UUID.fromString(moduleId), userId)</b>
<b class="nc">&nbsp;                .orElse(null);</b>
&nbsp;
<b class="nc">&nbsp;        if (!module.getCreatedBy().equals(userId) &amp;&amp; !module.getIsPublic() &amp;&amp; moduleUser == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    HttpStatus.FORBIDDEN.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        List&lt;FlashCardResponse&gt; flashCardResponses = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (FlashCard flashCard : module.getFlashCards()) {</b>
<b class="nc">&nbsp;            flashCardResponses.add(FlashCardResponse.builder()</b>
<b class="nc">&nbsp;                    .flashCardId(flashCard.getCardId().toString())</b>
<b class="nc">&nbsp;                    .vocabularyResponse(</b>
<b class="nc">&nbsp;                            VocabularyResponse.builder()</b>
<b class="nc">&nbsp;                                    .vocabularyId(flashCard.getVocabulary().getWordId())</b>
<b class="nc">&nbsp;                                    .word(flashCard.getVocabulary().getWord())</b>
<b class="nc">&nbsp;                                    .context(flashCard.getVocabulary().getContext())</b>
<b class="nc">&nbsp;                                    .meaning(flashCard.getVocabulary().getMeaning())</b>
<b class="nc">&nbsp;                                    .createdBy(flashCard.getVocabulary().getCreatedBy())</b>
<b class="nc">&nbsp;                                    .createdAt(flashCard.getVocabulary().getCreatedAt())</b>
<b class="nc">&nbsp;                                    .build()</b>
&nbsp;                    )
<b class="nc">&nbsp;                    .build());</b>
&nbsp;        }
<b class="nc">&nbsp;        ModuleResponse response = ModuleResponse.builder()</b>
<b class="nc">&nbsp;                .moduleId(module.getModuleId())</b>
<b class="nc">&nbsp;                .moduleName(module.getModuleName())</b>
<b class="nc">&nbsp;                .description(module.getDescription())</b>
<b class="nc">&nbsp;                .isPublic(module.getIsPublic())</b>
<b class="nc">&nbsp;                .flashCardIds(flashCardResponses)</b>
<b class="nc">&nbsp;                .createdBy(module.getCreatedBy())</b>
<b class="nc">&nbsp;                .createdAt(module.getCreatedAt())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;
<b class="nc">&nbsp;        return response;</b>
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;    }
&nbsp;    @Override
&nbsp;    public ModuleResponse updateModule(String moduleId, ModuleRequest moduleRequest, HttpServletRequest request) throws Exception {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Module module = moduleRepository.findById(UUID.fromString(moduleId))</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        HttpStatus.NOT_FOUND.value()</b>
&nbsp;                ));
&nbsp;
<b class="nc">&nbsp;        if (module.getIsDeleted()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    HttpStatus.NOT_FOUND.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!module.getCreatedBy().equals(userId)) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    &quot;not your module&quot;,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    HttpStatus.FORBIDDEN.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
&nbsp;        // Cập nhật thông tin module
<b class="nc">&nbsp;        module.setModuleName(moduleRequest.moduleName());</b>
<b class="nc">&nbsp;        module.setDescription(moduleRequest.moduleDescription());</b>
<b class="nc">&nbsp;        module.setIsPublic(moduleRequest.isPublic());</b>
<b class="nc">&nbsp;        module.setUpdatedBy(userId);</b>
&nbsp;
&nbsp;        // Xoá toàn bộ quan hệ cũ
<b class="nc">&nbsp;        module.getFlashCardModules().clear();</b>
<b class="nc">&nbsp;        moduleRepository.save(module);</b>
&nbsp;
<b class="nc">&nbsp;        List&lt;UUID&gt; vocabularyIds = moduleRequest.vocabularyIds();</b>
&nbsp;
<b class="nc">&nbsp;        for (UUID vocabularyId : vocabularyIds) {</b>
<b class="nc">&nbsp;            Vocabulary vocabulary = vocabularyRepository.findById(vocabularyId)</b>
<b class="nc">&nbsp;                    .orElseThrow(() -&gt; new AppException(&quot;Vocabulary not found&quot;, &quot;NOT_FOUND&quot;, HttpStatus.NOT_FOUND.value()));</b>
&nbsp;
<b class="nc">&nbsp;            Optional&lt;FlashCard&gt; existingFlashCardOpt = flashCardRepository.findByVocabularyId(vocabularyId, userId);</b>
&nbsp;
<b class="nc">&nbsp;            FlashCard flashCard = existingFlashCardOpt.orElseGet(() -&gt; {</b>
<b class="nc">&nbsp;                FlashCard newCard = new FlashCard();</b>
<b class="nc">&nbsp;                newCard.setVocabulary(vocabulary);</b>
<b class="nc">&nbsp;                newCard.setCreatedBy(userId);</b>
<b class="nc">&nbsp;                return flashCardRepository.save(newCard);</b>
&nbsp;            });
&nbsp;
&nbsp;            // Tránh tạo FlashCardModule trùng
<b class="nc">&nbsp;            boolean alreadyLinked = flashCardModuleRepository.existsByFlashCardAndModule(flashCard, module);</b>
<b class="nc">&nbsp;            if (!alreadyLinked) {</b>
<b class="nc">&nbsp;                FlashCardModule flashCardModule = new FlashCardModule();</b>
<b class="nc">&nbsp;                flashCardModule.setFlashCard(flashCard);</b>
<b class="nc">&nbsp;                flashCardModule.setModule(module);</b>
<b class="nc">&nbsp;                flashCardModule.setOrderIndex(0); // hoặc gán theo thứ tự nếu có</b>
&nbsp;
<b class="nc">&nbsp;                flashCard.getFlashCardModules().add(flashCardModule);</b>
<b class="nc">&nbsp;                module.getFlashCardModules().add(flashCardModule);</b>
&nbsp;
<b class="nc">&nbsp;                flashCardModuleRepository.save(flashCardModule);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        module = moduleRepository.save(module); // refresh</b>
&nbsp;
&nbsp;        // Chuẩn bị response
<b class="nc">&nbsp;        List&lt;FlashCardResponse&gt; flashCardResponses = module.getFlashCards().stream()</b>
<b class="nc">&nbsp;                .map(flashCard -&gt; FlashCardResponse.builder()</b>
<b class="nc">&nbsp;                        .flashCardId(flashCard.getCardId().toString())</b>
<b class="nc">&nbsp;                        .vocabularyResponse(</b>
<b class="nc">&nbsp;                                VocabularyResponse.builder()</b>
<b class="nc">&nbsp;                                        .vocabularyId(flashCard.getVocabulary().getWordId())</b>
<b class="nc">&nbsp;                                        .word(flashCard.getVocabulary().getWord())</b>
<b class="nc">&nbsp;                                        .context(flashCard.getVocabulary().getContext())</b>
<b class="nc">&nbsp;                                        .meaning(flashCard.getVocabulary().getMeaning())</b>
<b class="nc">&nbsp;                                        .createdBy(flashCard.getVocabulary().getCreatedBy())</b>
<b class="nc">&nbsp;                                        .createdAt(flashCard.getVocabulary().getCreatedAt())</b>
<b class="nc">&nbsp;                                        .build()</b>
&nbsp;                        )
<b class="nc">&nbsp;                        .build())</b>
<b class="nc">&nbsp;                .toList();</b>
&nbsp;
<b class="nc">&nbsp;        return ModuleResponse.builder()</b>
<b class="nc">&nbsp;                .moduleId(module.getModuleId())</b>
<b class="nc">&nbsp;                .moduleName(module.getModuleName())</b>
<b class="nc">&nbsp;                .description(module.getDescription())</b>
<b class="nc">&nbsp;                .isPublic(module.getIsPublic())</b>
<b class="nc">&nbsp;                .flashCardIds(flashCardResponses)</b>
<b class="nc">&nbsp;                .createdBy(module.getCreatedBy())</b>
<b class="nc">&nbsp;                .createdAt(module.getCreatedAt())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void shareModule(String moduleId, ShareModuleRequest shareModuleRequest, HttpServletRequest request) throws Exception {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        String accessToken = helper.getAccessToken(request);</b>
&nbsp;
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        Module module = moduleRepository.findById(UUID.fromString(moduleId))</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        HttpStatus.NOT_FOUND.value()</b>
&nbsp;                ));
<b class="nc">&nbsp;        if (module.getIsDeleted()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    HttpStatus.NOT_FOUND.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        if (!module.getCreatedBy().equals(userId)) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    HttpStatus.FORBIDDEN.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;        // now not share with usser, that is email
<b class="nc">&nbsp;        ResponseEntity&lt;BaseResponse&lt;UserAccessInfo&gt;&gt; user = null;</b>
<b class="nc">&nbsp;        for (String email : shareModuleRequest.users()) {</b>
&nbsp;            try {
<b class="nc">&nbsp;                user = authClient.getUserInfoByEmail(email, &quot;Bearer &quot; + accessToken);</b>
<b class="nc">&nbsp;                if (user == null) {</b>
<b class="nc">&nbsp;                    throw new AppException(</b>
<b class="nc">&nbsp;                            Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                            Constants.ErrorCode.NOT_FOUND,</b>
<b class="nc">&nbsp;                            HttpStatus.NOT_FOUND.value()</b>
&nbsp;                    );
&nbsp;                }
&nbsp;            }catch (Exception e){
<b class="nc">&nbsp;                throw new AppException(</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        Constants.ErrorCode.NOT_FOUND,</b>
<b class="nc">&nbsp;                        HttpStatus.NOT_FOUND.value()</b>
&nbsp;                );            }
<b class="nc">&nbsp;            var body = user.getBody();</b>
<b class="nc">&nbsp;            String sharedUserId = body.data().id();</b>
<b class="nc">&nbsp;            if (sharedUserId.equals(userId)) {</b>
&nbsp;                continue; // Không chia sẻ cho chính mình
&nbsp;            }
<b class="nc">&nbsp;            Optional&lt;ModuleUsers&gt; existingModuleUserOpt = module.getModuleUsers().stream()</b>
<b class="nc">&nbsp;                    .filter(mu -&gt; mu.getUserId().equals(sharedUserId))</b>
<b class="nc">&nbsp;                    .findFirst();</b>
<b class="nc">&nbsp;            if (existingModuleUserOpt.isPresent()) {</b>
<b class="nc">&nbsp;                ModuleUsers existingModuleUser = existingModuleUserOpt.get();</b>
<b class="nc">&nbsp;                if (existingModuleUser.getStatus() == 2) {</b>
<b class="nc">&nbsp;                    existingModuleUser.setStatus(0);</b>
<b class="nc">&nbsp;                    moduleUsersRepository.save(existingModuleUser);</b>
<b class="nc">&nbsp;                    log.info(&quot;Updated status of ModuleUsers for user {} to 0&quot;, sharedUserId);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    log.warn(&quot;Module {} is already shared with user {}&quot;, moduleId, sharedUserId);</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                ModuleUsers moduleUsers = new ModuleUsers();</b>
<b class="nc">&nbsp;                moduleUsers.setModule(module);</b>
<b class="nc">&nbsp;                moduleUsers.setUserId(sharedUserId);</b>
<b class="nc">&nbsp;                moduleUsers.setStatus(0); // set default status when sharing</b>
<b class="nc">&nbsp;                moduleUsers.setCreatedBy(userId);</b>
<b class="nc">&nbsp;                module.getModuleUsers().add(moduleUsers);</b>
<b class="nc">&nbsp;                moduleUsersRepository.save(moduleUsers);</b>
<b class="nc">&nbsp;                log.info(&quot;Shared module {} with new user {}&quot;, moduleId, sharedUserId);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        moduleRepository.save(module);</b>
&nbsp;
&nbsp;
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Page&lt;ModuleUserResponse&gt; getAllSharedModules(HttpServletRequest request, int page, int size, String sortBy, String sortDirection, String keyword, int status) throws Exception {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        if (sortBy == null || sortBy.isBlank()) {</b>
<b class="nc">&nbsp;            sortBy = &quot;createdAt&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (sortDirection == null || sortDirection.isBlank()) {</b>
<b class="nc">&nbsp;            sortDirection = &quot;asc&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        Sort sort = sortDirection.equalsIgnoreCase(&quot;desc&quot;)</b>
<b class="nc">&nbsp;                ? Sort.by(sortBy).descending()</b>
<b class="nc">&nbsp;                : Sort.by(sortBy).ascending();</b>
<b class="nc">&nbsp;        Pageable pageable = PageRequest.of(page, size, sort);</b>
&nbsp;        Page&lt;ModuleUsers&gt; modulePage;
&nbsp;        try {
<b class="nc">&nbsp;            modulePage = moduleUsersRepository.searchShareModules(keyword, pageable, userId, status);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;Database error when fetching shared modules for user: {}&quot;, userId, e);</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.INTERNAL_SERVER_ERROR,</b>
<b class="nc">&nbsp;                    Constants.ErrorCode.INTERNAL_SERVER_ERROR,</b>
<b class="nc">&nbsp;                    HttpStatus.INTERNAL_SERVER_ERROR.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        List&lt;ModuleUserResponse&gt; moduleResponses = modulePage.stream()</b>
<b class="nc">&nbsp;                .map(moduleUser -&gt; {</b>
<b class="nc">&nbsp;                    Module module = moduleUser.getModule();</b>
<b class="nc">&nbsp;                    List&lt;FlashCardResponse&gt; flashCardResponses = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                    for (FlashCard flashCard : module.getFlashCards()) {</b>
<b class="nc">&nbsp;                        flashCardResponses.add(FlashCardResponse.builder()</b>
<b class="nc">&nbsp;                                .flashCardId(flashCard.getCardId().toString())</b>
<b class="nc">&nbsp;                                .vocabularyResponse(</b>
<b class="nc">&nbsp;                                        VocabularyResponse.builder()</b>
<b class="nc">&nbsp;                                                .vocabularyId(flashCard.getVocabulary().getWordId())</b>
<b class="nc">&nbsp;                                                .word(flashCard.getVocabulary().getWord())</b>
<b class="nc">&nbsp;                                                .context(flashCard.getVocabulary().getContext())</b>
<b class="nc">&nbsp;                                                .meaning(flashCard.getVocabulary().getMeaning())</b>
<b class="nc">&nbsp;                                                .createdBy(flashCard.getVocabulary().getCreatedBy())</b>
<b class="nc">&nbsp;                                                .createdAt(flashCard.getVocabulary().getCreatedAt())</b>
<b class="nc">&nbsp;                                                .build()</b>
&nbsp;                                )
<b class="nc">&nbsp;                                .build());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    UserProfileResponse user = UserProfileResponse.builder().build();</b>
<b class="nc">&nbsp;                    UserProfileResponse share_to = UserProfileResponse.builder().build();</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        user = helper.getUserProfileById(module.getCreatedBy());</b>
<b class="nc">&nbsp;                        share_to = helper.getUserProfileById(moduleUser.getUserId());</b>
&nbsp;                    }catch (Exception e){
<b class="nc">&nbsp;                        log.error(&quot;Error fetching user profile for module creator: {}&quot;, module.getCreatedBy());</b>
<b class="nc">&nbsp;                        throw new AppException(</b>
<b class="nc">&nbsp;                                Constants.ErrorCodeMessage.INTERNAL_SERVER_ERROR,</b>
<b class="nc">&nbsp;                                &quot;Error fetching user profile&quot;,</b>
<b class="nc">&nbsp;                                HttpStatus.INTERNAL_SERVER_ERROR.value()</b>
&nbsp;                        );
&nbsp;                    }
<b class="nc">&nbsp;                    return ModuleUserResponse.builder()</b>
<b class="nc">&nbsp;                            .moduleId(module.getModuleId())</b>
<b class="nc">&nbsp;                            .moduleName(module.getModuleName())</b>
<b class="nc">&nbsp;                            .description(module.getDescription())</b>
<b class="nc">&nbsp;                            .isPublic(module.getIsPublic())</b>
<b class="nc">&nbsp;                            .flashCardIds(flashCardResponses)</b>
<b class="nc">&nbsp;                            .createdBy(user != null ? user.email() : module.getCreatedBy())</b>
<b class="nc">&nbsp;                            .shareTo(share_to != null ? share_to.email() : moduleUser.getUserId())</b>
<b class="nc">&nbsp;                            .createdAt(module.getCreatedAt())</b>
<b class="nc">&nbsp;                            .updatedBy(module.getUpdatedBy())</b>
<b class="nc">&nbsp;                            .status(moduleUser.getStatus() != null ? moduleUser.getStatus() : 0)</b>
<b class="nc">&nbsp;                            .updatedAt(module.getUpdatedAt())</b>
<b class="nc">&nbsp;                            .build();</b>
&nbsp;                })
<b class="nc">&nbsp;                .toList();</b>
&nbsp;
<b class="nc">&nbsp;        return new PageImpl&lt;&gt;(moduleResponses, pageable, modulePage.getTotalElements());</b>
&nbsp;
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void updateSharedModuleRequest(String moduleId, int status, HttpServletRequest request) throws Exception {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        Module module = moduleRepository.findById(UUID.fromString(moduleId))</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        HttpStatus.NOT_FOUND.value()</b>
&nbsp;                ));
<b class="nc">&nbsp;        if (module.getIsDeleted()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    HttpStatus.NOT_FOUND.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        Optional&lt;ModuleUsers&gt; moduleUserOpt = module.getModuleUsers().stream()</b>
<b class="nc">&nbsp;                .filter(mu -&gt; mu.getUserId().equals(userId))</b>
<b class="nc">&nbsp;                .findFirst();</b>
<b class="nc">&nbsp;        if (moduleUserOpt.isEmpty()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    &quot;ModuleUser not found for user: &quot; + userId,</b>
<b class="nc">&nbsp;                    HttpStatus.NOT_FOUND.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        ModuleUsers moduleUser = moduleUserOpt.get();</b>
<b class="nc">&nbsp;        if (moduleUser.getStatus() == 1) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    &quot;You have already accepted this module&quot;,</b>
<b class="nc">&nbsp;                    HttpStatus.FORBIDDEN.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        if (moduleUser.getStatus() == 2) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    &quot;You have already denied this module&quot;,</b>
<b class="nc">&nbsp;                    HttpStatus.FORBIDDEN.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        if (status == ModuleUserStatus.ACCEPTED.ordinal()) {</b>
<b class="nc">&nbsp;            moduleUser.setStatus(1); // 1: allowed</b>
<b class="nc">&nbsp;        } else if (status == ModuleUserStatus.REJECTED.ordinal()) {</b>
<b class="nc">&nbsp;            moduleUser.setStatus(2); // 2: denied</b>
&nbsp;        } else {
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.INVALID_REQUEST,</b>
<b class="nc">&nbsp;                    &quot;Invalid status: &quot; + status,</b>
<b class="nc">&nbsp;                    HttpStatus.BAD_REQUEST.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        moduleUsersRepository.save(moduleUser);</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Page&lt;ModuleUserResponse&gt; getAllMySharedModules(HttpServletRequest request, int i, int size, String sortBy, String sortDirection, String keyword) throws Exception {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        if (sortBy == null || sortBy.isBlank()) {</b>
<b class="nc">&nbsp;            sortBy = &quot;createdAt&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (sortDirection == null || sortDirection.isBlank()) {</b>
<b class="nc">&nbsp;            sortDirection = &quot;asc&quot;;</b>
&nbsp;        }
<b class="nc">&nbsp;        Sort sort = sortDirection.equalsIgnoreCase(&quot;desc&quot;)</b>
<b class="nc">&nbsp;                ? Sort.by(sortBy).descending()</b>
<b class="nc">&nbsp;                : Sort.by(sortBy).ascending();</b>
<b class="nc">&nbsp;        Pageable pageable = PageRequest.of(i, size, sort);</b>
&nbsp;        Page&lt;ModuleUsers&gt; modulePage;
&nbsp;        try {
<b class="nc">&nbsp;            modulePage = moduleUsersRepository.searchMyShareModules(keyword, pageable, userId);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;Database error when fetching shared modules for user: {}&quot;, userId, e);</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.INTERNAL_SERVER_ERROR,</b>
<b class="nc">&nbsp;                    Constants.ErrorCode.INTERNAL_SERVER_ERROR,</b>
<b class="nc">&nbsp;                    HttpStatus.INTERNAL_SERVER_ERROR.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        List&lt;ModuleUserResponse&gt; moduleResponses = modulePage.stream()</b>
<b class="nc">&nbsp;                .map(moduleUser -&gt; {</b>
<b class="nc">&nbsp;                    Module module = moduleUser.getModule();</b>
<b class="nc">&nbsp;                    List&lt;FlashCardResponse&gt; flashCardResponses = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;                    for (FlashCard flashCard : module.getFlashCards()) {</b>
<b class="nc">&nbsp;                        flashCardResponses.add(FlashCardResponse.builder()</b>
<b class="nc">&nbsp;                                .flashCardId(flashCard.getCardId().toString())</b>
<b class="nc">&nbsp;                                .vocabularyResponse(</b>
<b class="nc">&nbsp;                                        VocabularyResponse.builder()</b>
<b class="nc">&nbsp;                                                .vocabularyId(flashCard.getVocabulary().getWordId())</b>
<b class="nc">&nbsp;                                                .word(flashCard.getVocabulary().getWord())</b>
<b class="nc">&nbsp;                                                .context(flashCard.getVocabulary().getContext())</b>
<b class="nc">&nbsp;                                                .meaning(flashCard.getVocabulary().getMeaning())</b>
<b class="nc">&nbsp;                                                .createdBy(flashCard.getVocabulary().getCreatedBy())</b>
<b class="nc">&nbsp;                                                .createdAt(flashCard.getVocabulary().getCreatedAt())</b>
<b class="nc">&nbsp;                                                .build()</b>
&nbsp;                                )
<b class="nc">&nbsp;                                .build());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    UserProfileResponse user = UserProfileResponse.builder().build();</b>
<b class="nc">&nbsp;                    UserProfileResponse share_to = UserProfileResponse.builder().build();</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        user = helper.getUserProfileById(module.getCreatedBy());</b>
<b class="nc">&nbsp;                        share_to = helper.getUserProfileById(moduleUser.getUserId());</b>
&nbsp;                    } catch (Exception e) {
<b class="nc">&nbsp;                        log.error(&quot;Error fetching user profile for module creator: {}&quot;, module.getCreatedBy());</b>
<b class="nc">&nbsp;                        throw new AppException(</b>
<b class="nc">&nbsp;                                Constants.ErrorCodeMessage.INTERNAL_SERVER_ERROR,</b>
<b class="nc">&nbsp;                                &quot;Error fetching user profile&quot;,</b>
<b class="nc">&nbsp;                                HttpStatus.INTERNAL_SERVER_ERROR.value()</b>
&nbsp;                        );
&nbsp;                    }
<b class="nc">&nbsp;                    return ModuleUserResponse.builder()</b>
<b class="nc">&nbsp;                            .moduleId(module.getModuleId())</b>
<b class="nc">&nbsp;                            .moduleName(module.getModuleName())</b>
<b class="nc">&nbsp;                            .description(module.getDescription())</b>
<b class="nc">&nbsp;                            .isPublic(module.getIsPublic())</b>
<b class="nc">&nbsp;                            .flashCardIds(flashCardResponses)</b>
<b class="nc">&nbsp;                            .createdBy(user != null ? user.email() : module.getCreatedBy())</b>
<b class="nc">&nbsp;                            .shareTo(share_to != null ? share_to.email() : moduleUser.getUserId())</b>
<b class="nc">&nbsp;                            .createdAt(module.getCreatedAt())</b>
<b class="nc">&nbsp;                            .updatedBy(module.getUpdatedBy())</b>
<b class="nc">&nbsp;                            .updatedAt(module.getUpdatedAt())</b>
<b class="nc">&nbsp;                            .status(moduleUser.getStatus() != null ? moduleUser.getStatus() : 0)</b>
<b class="nc">&nbsp;                            .build();</b>
&nbsp;                })
<b class="nc">&nbsp;                .toList();</b>
<b class="nc">&nbsp;        return new PageImpl&lt;&gt;(moduleResponses, pageable, modulePage.getTotalElements());</b>
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ModuleResponse cloneModule(String moduleId, HttpServletRequest request) throws Exception {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Module originalModule = moduleRepository.findById(UUID.fromString(moduleId))</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        HttpStatus.NOT_FOUND.value()</b>
&nbsp;                ));
&nbsp;
<b class="nc">&nbsp;        if (originalModule.getIsDeleted()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    HttpStatus.NOT_FOUND.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Optional&lt;ModuleUsers&gt; moduleUser = moduleUsersRepository.findByModuleIdAndUserId(UUID.fromString(moduleId), userId);</b>
&nbsp;
<b class="nc">&nbsp;        if (!originalModule.getIsPublic() &amp;&amp; moduleUser.isEmpty()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    &quot;You do not have permission to clone this module&quot;,</b>
<b class="nc">&nbsp;                    HttpStatus.FORBIDDEN.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
&nbsp;        // Tạo module mới
<b class="nc">&nbsp;        Module clonedModule = new Module();</b>
<b class="nc">&nbsp;        clonedModule.setModuleName(originalModule.getModuleName() + &quot; - Copy&quot;);</b>
<b class="nc">&nbsp;        clonedModule.setDescription(originalModule.getDescription());</b>
<b class="nc">&nbsp;        clonedModule.setIsPublic(false);</b>
<b class="nc">&nbsp;        clonedModule.setCreatedBy(userId);</b>
&nbsp;
<b class="nc">&nbsp;        Module savedClonedModule = moduleRepository.save(clonedModule);</b>
&nbsp;
<b class="nc">&nbsp;        int index = 0; // optional: để đặt thứ tự nếu cần</b>
<b class="nc">&nbsp;        for (FlashCard flashCard : originalModule.getFlashCards()) {</b>
<b class="nc">&nbsp;            Vocabulary vocabulary = flashCard.getVocabulary();</b>
<b class="nc">&nbsp;            Optional&lt;FlashCard&gt; existingFlashCard = flashCardRepository.findByVocabularyId(vocabulary.getWordId(), userId);</b>
&nbsp;
<b class="nc">&nbsp;            FlashCard flashCardClone = existingFlashCard.orElseGet(() -&gt; {</b>
<b class="nc">&nbsp;                FlashCard newCard = new FlashCard();</b>
<b class="nc">&nbsp;                newCard.setVocabulary(vocabulary);</b>
<b class="nc">&nbsp;                newCard.setCreatedBy(userId);</b>
<b class="nc">&nbsp;                return flashCardRepository.save(newCard);</b>
&nbsp;            });
&nbsp;
<b class="nc">&nbsp;            FlashCardModule flashCardModule = new FlashCardModule();</b>
<b class="nc">&nbsp;            flashCardModule.setFlashCard(flashCardClone);</b>
<b class="nc">&nbsp;            flashCardModule.setModule(savedClonedModule);</b>
<b class="nc">&nbsp;            flashCardModule.setOrderIndex(index++); // nếu cần giữ thứ tự</b>
&nbsp;
<b class="nc">&nbsp;            flashCardModuleRepository.save(flashCardModule);</b>
&nbsp;
&nbsp;            // Nếu có mappedBy (bidirectional)
<b class="nc">&nbsp;            flashCardClone.getFlashCardModules().add(flashCardModule);</b>
<b class="nc">&nbsp;            savedClonedModule.getFlashCardModules().add(flashCardModule);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Build response như ở createModule
<b class="nc">&nbsp;        List&lt;FlashCardResponse&gt; flashCardResponses = savedClonedModule.getFlashCards().stream()</b>
<b class="nc">&nbsp;                .map(card -&gt; FlashCardResponse.builder()</b>
<b class="nc">&nbsp;                        .flashCardId(card.getCardId().toString())</b>
<b class="nc">&nbsp;                        .vocabularyResponse(</b>
<b class="nc">&nbsp;                                VocabularyResponse.builder()</b>
<b class="nc">&nbsp;                                        .vocabularyId(card.getVocabulary().getWordId())</b>
<b class="nc">&nbsp;                                        .word(card.getVocabulary().getWord())</b>
<b class="nc">&nbsp;                                        .context(card.getVocabulary().getContext())</b>
<b class="nc">&nbsp;                                        .meaning(card.getVocabulary().getMeaning())</b>
<b class="nc">&nbsp;                                        .createdBy(card.getVocabulary().getCreatedBy())</b>
<b class="nc">&nbsp;                                        .createdAt(card.getVocabulary().getCreatedAt())</b>
<b class="nc">&nbsp;                                        .build()</b>
&nbsp;                        )
<b class="nc">&nbsp;                        .build())</b>
<b class="nc">&nbsp;                .toList();</b>
&nbsp;
<b class="nc">&nbsp;        return ModuleResponse.builder()</b>
<b class="nc">&nbsp;                .moduleId(savedClonedModule.getModuleId())</b>
<b class="nc">&nbsp;                .moduleName(savedClonedModule.getModuleName())</b>
<b class="nc">&nbsp;                .description(savedClonedModule.getDescription())</b>
<b class="nc">&nbsp;                .isPublic(savedClonedModule.getIsPublic())</b>
<b class="nc">&nbsp;                .flashCardIds(flashCardResponses)</b>
<b class="nc">&nbsp;                .createdBy(savedClonedModule.getCreatedBy())</b>
<b class="nc">&nbsp;                .createdAt(savedClonedModule.getCreatedAt())</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ModuleProgressResponse getModuleProgress(String moduleId, HttpServletRequest request) throws Exception {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        Module module = moduleRepository.findById(UUID.fromString(moduleId))</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        HttpStatus.NOT_FOUND.value()</b>
&nbsp;                ));
<b class="nc">&nbsp;        if (module.getIsDeleted()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    HttpStatus.NOT_FOUND.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        Optional&lt;ModuleUsers&gt; moduleUser = moduleUsersRepository.findByModuleIdAndUserId(UUID.fromString(moduleId), userId);</b>
<b class="nc">&nbsp;        if (moduleUser.isEmpty()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    &quot;you do not have permission to view this module, or still not clone this module&quot;,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    HttpStatus.FORBIDDEN.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        ModuleUsers moduleUsers = moduleUser.get();</b>
<b class="nc">&nbsp;        Integer status = moduleUsers.getStatus() != null ? moduleUsers.getStatus() : 0;</b>
<b class="nc">&nbsp;        if (status == 2) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    &quot;you have denied or still not accept this module, please contact the owner to re-allow you&quot;,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    HttpStatus.FORBIDDEN.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        List&lt;FlashCard&gt; flashCards = module.getFlashCards();</b>
<b class="nc">&nbsp;        for( FlashCard flashCard : flashCards) {</b>
<b class="nc">&nbsp;            if(flashCardProgressRepository.findByModuleUserIdAndFlashcardId(moduleUsers.getId(), flashCard.getCardId().toString()).isEmpty()) {</b>
<b class="nc">&nbsp;                FlashCardProgress flashCardProgress = new FlashCardProgress();</b>
<b class="nc">&nbsp;                flashCardProgress.setFlashcardId(flashCard.getCardId().toString());</b>
<b class="nc">&nbsp;                flashCardProgress.setModuleUsers(moduleUsers);</b>
<b class="nc">&nbsp;                flashCardProgress.setStatus(0); // default status</b>
<b class="nc">&nbsp;                flashCardProgressRepository.save(flashCardProgress);</b>
<b class="nc">&nbsp;                moduleUsers.getFlashcardProgressList().add(flashCardProgress);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        List&lt;FlashCardProgressResponse&gt; flashCardProgressResponses = moduleUsers.getFlashcardProgressList().stream()</b>
<b class="nc">&nbsp;                .map(flashCardProgress -&gt; {</b>
&nbsp;
<b class="nc">&nbsp;                    FlashCard flashCard = flashCardRepository.findById(UUID.fromString(flashCardProgress.getFlashcardId()))</b>
<b class="nc">&nbsp;                            .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                                    &quot;Flashcard not found: &quot; + flashCardProgress.getFlashcardId(),</b>
<b class="nc">&nbsp;                                    HttpStatus.NOT_FOUND.value()</b>
&nbsp;                            ));
&nbsp;
<b class="nc">&nbsp;                    Vocabulary vocabulary = flashCard.getVocabulary();</b>
&nbsp;
<b class="nc">&nbsp;                    FlashCardResponse flashCardResponse = FlashCardResponse.builder()</b>
<b class="nc">&nbsp;                            .flashCardId(flashCard.getCardId().toString())</b>
<b class="nc">&nbsp;                            .vocabularyResponse(</b>
<b class="nc">&nbsp;                                    VocabularyResponse.builder()</b>
<b class="nc">&nbsp;                                            .vocabularyId(vocabulary.getWordId())</b>
<b class="nc">&nbsp;                                            .word(vocabulary.getWord())</b>
<b class="nc">&nbsp;                                            .context(vocabulary.getContext())</b>
<b class="nc">&nbsp;                                            .meaning(vocabulary.getMeaning())</b>
<b class="nc">&nbsp;                                            .createdBy(vocabulary.getCreatedBy())</b>
<b class="nc">&nbsp;                                            .createdAt(vocabulary.getCreatedAt())</b>
<b class="nc">&nbsp;                                            .build()</b>
&nbsp;                            )
<b class="nc">&nbsp;                            .build();</b>
&nbsp;
<b class="nc">&nbsp;                    return FlashCardProgressResponse.builder()</b>
<b class="nc">&nbsp;                            .flashcardId(flashCardProgress.getFlashcardId())</b>
<b class="nc">&nbsp;                            .status(flashCardProgress.getStatus())</b>
<b class="nc">&nbsp;                            .isHighlighted(flashCardProgress.getIsHighlighted())</b>
<b class="nc">&nbsp;                            .flashcardDetail(flashCardResponse)</b>
<b class="nc">&nbsp;                            .build();</b>
&nbsp;                })
<b class="nc">&nbsp;                .toList();</b>
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
<b class="nc">&nbsp;        ModuleProgressResponse progressResponse = ModuleProgressResponse.builder().</b>
<b class="nc">&nbsp;                id(moduleUsers.getId())</b>
<b class="nc">&nbsp;                .moduleId(module.getModuleId().toString())</b>
<b class="nc">&nbsp;                .moduleName(module.getModuleName())</b>
<b class="nc">&nbsp;                .userId(userId)</b>
<b class="nc">&nbsp;                .status(status)</b>
<b class="nc">&nbsp;                .attempts(moduleUsers.getAttempts())</b>
<b class="nc">&nbsp;                .progress(moduleUsers.getProgress())</b>
<b class="nc">&nbsp;                .learningStatus(moduleUsers.getLearningStatus())</b>
<b class="nc">&nbsp;                .timeSpent(moduleUsers.getTimeSpent() != null ? moduleUsers.getTimeSpent() : 0L)</b>
<b class="nc">&nbsp;                .lastIndexRead(moduleUsers.getLastIndexRead() != null ? moduleUsers.getLastIndexRead() : 0)</b>
<b class="nc">&nbsp;                .flashcardProgresses(flashCardProgressResponses)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;
&nbsp;
&nbsp;
<b class="nc">&nbsp;        return progressResponse;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ModuleProgressResponse updateModuleProgress(String moduleId, ModuleProgressRequest moduleProgressRequest, HttpServletRequest request) throws Exception {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        Module module = moduleRepository.findById(UUID.fromString(moduleId))</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        HttpStatus.NOT_FOUND.value()</b>
&nbsp;                ));
<b class="nc">&nbsp;        if (module.getIsDeleted()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    HttpStatus.NOT_FOUND.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        Optional&lt;ModuleUsers&gt; moduleUser = moduleUsersRepository.findByModuleIdAndUserId(UUID.fromString(moduleId), userId);</b>
<b class="nc">&nbsp;        if (moduleUser.isEmpty()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    &quot;you do not have permission to view this module, or still not clone this module&quot;,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    HttpStatus.FORBIDDEN.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        ModuleUsers moduleUsers = moduleUser.get();</b>
<b class="nc">&nbsp;        Integer currentStatus = moduleUsers.getStatus() != null ? moduleUsers.getStatus() : 0;</b>
<b class="nc">&nbsp;        if (currentStatus == 2) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    &quot;you have denied or still not accept this module, please contact the owner to re-allow you&quot;,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    HttpStatus.FORBIDDEN.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (moduleProgressRequest.status() != null) {</b>
<b class="nc">&nbsp;            moduleUsers.setStatus(moduleProgressRequest.status());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (moduleProgressRequest.lastIndexRead() != null) {</b>
<b class="nc">&nbsp;            moduleUsers.setLastIndexRead(moduleProgressRequest.lastIndexRead());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (moduleProgressRequest.highlightedFlashcardIds() != null) {</b>
<b class="nc">&nbsp;            for (String flashcardId : moduleProgressRequest.highlightedFlashcardIds()) {</b>
<b class="nc">&nbsp;                if (moduleUsers.getFlashcardProgressList() == null) {</b>
<b class="nc">&nbsp;                    moduleUsers.setFlashcardProgressList(new ArrayList&lt;&gt;());</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (flashCardProgressRepository.findByModuleUserIdAndFlashcardId(moduleUsers.getId(), flashcardId).isEmpty()) {</b>
<b class="nc">&nbsp;                    FlashCardProgress flashcardProgress = new FlashCardProgress();</b>
<b class="nc">&nbsp;                    flashcardProgress.setFlashcardId(flashcardId);</b>
<b class="nc">&nbsp;                    flashcardProgress.setModuleUsers(moduleUsers);</b>
<b class="nc">&nbsp;                    flashcardProgress.setStatus(0); // default status</b>
<b class="nc">&nbsp;                    flashcardProgress = flashCardProgressRepository.save(flashcardProgress);</b>
<b class="nc">&nbsp;                    moduleUsers.getFlashcardProgressList().add(flashcardProgress);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (moduleProgressRequest.timeSpent() != null) {</b>
<b class="nc">&nbsp;            Long current = moduleUsers.getTimeSpent() == null ? 0L : moduleUsers.getTimeSpent();</b>
<b class="nc">&nbsp;            moduleUsers.setTimeSpent(current + moduleProgressRequest.timeSpent());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (moduleProgressRequest.progress() != null) {</b>
<b class="nc">&nbsp;            moduleUsers.setProgress(moduleProgressRequest.progress());</b>
&nbsp;        }
<b class="nc">&nbsp;        if (moduleProgressRequest.learningStatus() != null) {</b>
<b class="nc">&nbsp;            moduleUsers.setLearningStatus(LearningStatus.valueOf(moduleProgressRequest.learningStatus()));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        moduleUsers.setUpdatedBy(userId);</b>
<b class="nc">&nbsp;        moduleUsers = moduleUsersRepository.save(moduleUsers);</b>
<b class="nc">&nbsp;        List&lt;FlashCardProgress&gt; flashCardProgresses = moduleUsers.getFlashcardProgressList();</b>
<b class="nc">&nbsp;        List&lt;FlashCardProgressResponse&gt; flashCardProgressResponses = flashCardProgresses.stream()</b>
<b class="nc">&nbsp;                .map(flashCardProgress -&gt; FlashCardProgressResponse.builder()</b>
<b class="nc">&nbsp;                        .flashcardId(flashCardProgress.getFlashcardId())</b>
<b class="nc">&nbsp;                        .status(flashCardProgress.getStatus())</b>
<b class="nc">&nbsp;                        .isHighlighted(flashCardProgress.getIsHighlighted())</b>
<b class="nc">&nbsp;                        .build())</b>
<b class="nc">&nbsp;                .toList();</b>
<b class="nc">&nbsp;        ModuleProgressResponse progressResponse = ModuleProgressResponse.builder()</b>
<b class="nc">&nbsp;                .id(moduleUsers.getId())</b>
<b class="nc">&nbsp;                .moduleId(module.getModuleId().toString())</b>
<b class="nc">&nbsp;                .moduleName(module.getModuleName())</b>
<b class="nc">&nbsp;                .attempts(moduleUsers.getAttempts())</b>
<b class="nc">&nbsp;                .userId(userId)</b>
<b class="nc">&nbsp;                .timeSpent(moduleUsers.getTimeSpent())</b>
<b class="nc">&nbsp;                .progress(moduleUsers.getProgress())</b>
<b class="nc">&nbsp;                .status(moduleUsers.getStatus() != null ? moduleUsers.getStatus() : 0)</b>
<b class="nc">&nbsp;                .lastIndexRead(moduleUsers.getLastIndexRead() != null ? moduleUsers.getLastIndexRead() : 0)</b>
<b class="nc">&nbsp;                .learningStatus(moduleUsers.getLearningStatus())</b>
<b class="nc">&nbsp;                .flashcardProgresses(flashCardProgressResponses)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;
<b class="nc">&nbsp;        return  progressResponse;</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void updateFlashcardProgress(String moduleId, FlashcardProgressRequest flashcardProgressRequest, HttpServletRequest request) throws Exception {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;        
&nbsp;        // Verify module exists and user has access
<b class="nc">&nbsp;        Module module = moduleRepository.findById(UUID.fromString(moduleId))</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        HttpStatus.NOT_FOUND.value()</b>
&nbsp;                ));
&nbsp;                
<b class="nc">&nbsp;        if (module.getIsDeleted()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    HttpStatus.NOT_FOUND.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;        
&nbsp;        // Check if user has access to this module
<b class="nc">&nbsp;        Optional&lt;ModuleUsers&gt; moduleUser = moduleUsersRepository.findByModuleIdAndUserId(UUID.fromString(moduleId), userId);</b>
<b class="nc">&nbsp;        if (moduleUser.isEmpty()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    &quot;You do not have permission to access this module&quot;,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    HttpStatus.FORBIDDEN.value()</b>
&nbsp;            );
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        ModuleUsers moduleUsers = moduleUser.get();</b>
<b class="nc">&nbsp;        Integer status = moduleUsers.getStatus() != null ? moduleUsers.getStatus() : 0;</b>
<b class="nc">&nbsp;        if (status == 2) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    &quot;You have denied access to this module&quot;,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                    HttpStatus.FORBIDDEN.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        moduleUsers.setLearningStatus(LearningStatus.LEARNING);</b>
&nbsp;        
&nbsp;        // Update last index read (increment if correct answer)
<b class="nc">&nbsp;        if (flashcardProgressRequest.isCorrect()) {</b>
<b class="nc">&nbsp;            Integer currentIndex = moduleUsers.getLastIndexRead() != null ? moduleUsers.getLastIndexRead() : 0;</b>
<b class="nc">&nbsp;            moduleUsers.setLastIndexRead(currentIndex + 1);</b>
&nbsp;
&nbsp;
&nbsp;        }
&nbsp;
&nbsp;        
&nbsp;        // Add to highlighted flashcards if incorrect
<b class="nc">&nbsp;        List&lt;FlashCardProgress&gt; flashCardProgresses = moduleUsers.getFlashcardProgressList();</b>
<b class="nc">&nbsp;        if (flashCardProgresses == null) {</b>
<b class="nc">&nbsp;            flashCardProgresses = new ArrayList&lt;&gt;();</b>
&nbsp;        }
<b class="nc">&nbsp;        FlashCardProgress existingProgress = flashCardProgressRepository.findByModuleUserIdAndFlashcardId(moduleUsers.getId(), flashcardProgressRequest.flashcardId())</b>
<b class="nc">&nbsp;                .orElse(null);</b>
<b class="nc">&nbsp;        if (existingProgress == null) {</b>
<b class="nc">&nbsp;            FlashCardProgress flashcardProgress = new FlashCardProgress();</b>
<b class="nc">&nbsp;            flashcardProgress.setFlashcardId(flashcardProgressRequest.flashcardId());</b>
<b class="nc">&nbsp;            flashcardProgress.setModuleUsers(moduleUsers);</b>
<b class="nc">&nbsp;            if (flashcardProgressRequest.isCorrect()) {</b>
<b class="nc">&nbsp;                flashcardProgress.setStatus(2);</b>
&nbsp;            }else{
<b class="nc">&nbsp;                flashcardProgress.setStatus(1);</b>
&nbsp;
&nbsp;            }
<b class="nc">&nbsp;            flashcardProgress = flashCardProgressRepository.save(flashcardProgress);</b>
<b class="nc">&nbsp;            flashCardProgresses.add(flashcardProgress);</b>
&nbsp;        }else{
<b class="nc">&nbsp;            existingProgress.setStatus(flashcardProgressRequest.isCorrect() ? 2 : 1);</b>
<b class="nc">&nbsp;            flashCardProgressRepository.save(existingProgress);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (flashcardProgressRequest.isHighlighted()){</b>
<b class="nc">&nbsp;            Optional&lt;FlashCardProgress&gt; flashCardProgress = flashCardProgressRepository.findByModuleUserIdAndFlashcardId(moduleUsers.getId(), flashcardProgressRequest.flashcardId());</b>
<b class="nc">&nbsp;            FlashCardProgress flashcardProgress2 = flashCardProgress.orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    &quot;Flashcard progress not found for module user: &quot; + moduleUsers.getId() + &quot; and flashcard: &quot; + flashcardProgressRequest.flashcardId(),</b>
<b class="nc">&nbsp;                    HttpStatus.NOT_FOUND.value()</b>
&nbsp;            ));
<b class="nc">&nbsp;            flashcardProgress2.setIsHighlighted(flashcardProgressRequest.isHighlighted());</b>
<b class="nc">&nbsp;            flashCardProgressRepository.save(flashcardProgress2);</b>
&nbsp;
&nbsp;        }
&nbsp;        // Update progress
<b class="nc">&nbsp;        Double currentProgress = moduleUsers.getProgress() != null ? moduleUsers.getProgress() : 0.0;</b>
&nbsp;        // caculate the correct flashcard vs total flashcard of thif moduleUsers
<b class="nc">&nbsp;        long correctCount = flashCardProgresses.stream()</b>
<b class="nc">&nbsp;                .filter(fcp -&gt; fcp.getStatus() == 2) // Assuming status 2 means correct</b>
<b class="nc">&nbsp;                .count();</b>
<b class="nc">&nbsp;        long totalCount = flashCardProgresses.size();</b>
<b class="nc">&nbsp;        if (totalCount &gt; 0) {</b>
<b class="nc">&nbsp;            double newProgress = (double) correctCount / totalCount * 100; // Calculate percentage</b>
<b class="nc">&nbsp;            moduleUsers.setProgress(newProgress);</b>
<b class="nc">&nbsp;            if (newProgress &gt;= 100.0) {</b>
<b class="nc">&nbsp;                moduleUsers.setLearningStatus(LearningStatus.MASTERED);</b>
<b class="nc">&nbsp;            } else if (newProgress &gt; 0.0) {</b>
<b class="nc">&nbsp;                moduleUsers.setLearningStatus(LearningStatus.LEARNING);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                moduleUsers.setLearningStatus(LearningStatus.NEW);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            moduleUsers.setProgress(0.0); // No flashcards, reset progress</b>
&nbsp;        }
&nbsp;
&nbsp;        
<b class="nc">&nbsp;        moduleUsers.setUpdatedBy(userId);</b>
<b class="nc">&nbsp;        moduleUsersRepository.save(moduleUsers);</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public ModuleProgressResponse refreshModuleProgress(String moduleId, ModuleFlashCardRequest moduleFlashCardRequest, HttpServletRequest request) {
<b class="nc">&nbsp;        String userId = helper.getUserIdFromToken(request);</b>
<b class="nc">&nbsp;        if (userId == null) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.UNAUTHORIZED,</b>
<b class="nc">&nbsp;                    HttpStatus.UNAUTHORIZED.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        Module module = moduleRepository.findById(UUID.fromString(moduleId))</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                        HttpStatus.NOT_FOUND.value()</b>
&nbsp;                ));
<b class="nc">&nbsp;        if (module.getIsDeleted()) {</b>
<b class="nc">&nbsp;            throw new AppException(</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    Constants.ErrorCodeMessage.NOT_FOUND,</b>
<b class="nc">&nbsp;                    HttpStatus.NOT_FOUND.value()</b>
&nbsp;            );
&nbsp;        }
<b class="nc">&nbsp;        ModuleUsers moduleUsers = moduleUsersRepository.findByModuleIdAndUserId(UUID.fromString(moduleId), userId)</b>
<b class="nc">&nbsp;                .orElseThrow(() -&gt; new AppException(</b>
<b class="nc">&nbsp;                        &quot;You do not have permission to view this module, or still not clone this module&quot;,</b>
<b class="nc">&nbsp;                        Constants.ErrorCodeMessage.FORBIDDEN,</b>
<b class="nc">&nbsp;                        HttpStatus.FORBIDDEN.value()</b>
&nbsp;                ));
<b class="nc">&nbsp;        moduleUsers.setProgress(0.0);</b>
<b class="nc">&nbsp;        if(moduleUsers.getLearningStatus() != LearningStatus.NEW &amp;&amp; moduleFlashCardRequest.learningStatus() == LearningStatus.NEW) {</b>
<b class="nc">&nbsp;            moduleUsers.setLearningStatus(LearningStatus.LEARNING);</b>
<b class="nc">&nbsp;            moduleUsers.setAttempts(moduleUsers.getAttempts() != null ? moduleUsers.getAttempts() + 1 : 1);</b>
&nbsp;        }
<b class="nc">&nbsp;        moduleUsers.setLearningStatus(moduleFlashCardRequest.learningStatus());</b>
<b class="nc">&nbsp;        moduleUsers.setUpdatedBy(userId);</b>
<b class="nc">&nbsp;        moduleUsers.setUpdatedAt(LocalDateTime.now());</b>
<b class="nc">&nbsp;        if(moduleFlashCardRequest.learningStatus() == LearningStatus.NEW){</b>
<b class="nc">&nbsp;            List&lt;FlashCardProgress&gt; flashCardProgresses = moduleUsers.getFlashcardProgressList();</b>
<b class="nc">&nbsp;            for(FlashCardProgress flashCardProgress : flashCardProgresses) {</b>
<b class="nc">&nbsp;                flashCardProgress.setStatus(0); // reset status to 0</b>
<b class="nc">&nbsp;                flashCardProgress.setIsHighlighted(false); // reset highlight</b>
<b class="nc">&nbsp;                flashCardProgressRepository.save(flashCardProgress);</b>
&nbsp;            }
&nbsp;
&nbsp;        }
<b class="nc">&nbsp;        moduleUsers = moduleUsersRepository.save(moduleUsers);</b>
<b class="nc">&nbsp;        List&lt;FlashCardProgress&gt; flashCardProgresses = moduleUsers.getFlashcardProgressList();</b>
<b class="nc">&nbsp;        List&lt;FlashCardProgressResponse&gt; flashCardProgressResponses = flashCardProgresses.stream()</b>
<b class="nc">&nbsp;                .map(flashCardProgress -&gt; FlashCardProgressResponse.builder()</b>
<b class="nc">&nbsp;                        .flashcardId(flashCardProgress.getFlashcardId())</b>
<b class="nc">&nbsp;                        .status(flashCardProgress.getStatus())</b>
<b class="nc">&nbsp;                        .isHighlighted(flashCardProgress.getIsHighlighted())</b>
<b class="nc">&nbsp;                        .build())</b>
<b class="nc">&nbsp;                .toList();</b>
<b class="nc">&nbsp;        ModuleProgressResponse progressResponse = ModuleProgressResponse.builder()</b>
<b class="nc">&nbsp;                .id(moduleUsers.getId())</b>
<b class="nc">&nbsp;                .moduleId(module.getModuleId().toString())</b>
<b class="nc">&nbsp;                .moduleName(module.getModuleName())</b>
<b class="nc">&nbsp;                .attempts(moduleUsers.getAttempts())</b>
<b class="nc">&nbsp;                .userId(userId)</b>
<b class="nc">&nbsp;                .timeSpent(moduleUsers.getTimeSpent())</b>
<b class="nc">&nbsp;                .progress(moduleUsers.getProgress())</b>
<b class="nc">&nbsp;                .status(moduleUsers.getStatus() != null ? moduleUsers.getStatus() : 0)</b>
<b class="nc">&nbsp;                .lastIndexRead(moduleUsers.getLastIndexRead() != null ? moduleUsers.getLastIndexRead() : 0)</b>
<b class="nc">&nbsp;                .learningStatus(moduleUsers.getLearningStatus())</b>
<b class="nc">&nbsp;                .flashcardProgresses(flashCardProgressResponses)</b>
<b class="nc">&nbsp;                .build();</b>
&nbsp;
<b class="nc">&nbsp;        return  progressResponse;</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-08-14 07:34</div>
</div>
</body>
</html>
